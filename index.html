<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MR_TOOLS Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif;}
body {
    background: radial-gradient(circle at center, #1a0a0a, #000000);
    min-height:100vh;
    padding:20px;
    overflow-x: hidden;
    color: #e0e0e0;
    position: relative;
}
body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 30%, rgba(153, 0, 0, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(102, 0, 0, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(153, 0, 51, 0.3) 0%, transparent 50%);
    z-index: -2;
}

.header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(145deg, #1a0a0a, #2a0a0a);
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(153, 0, 0, 0.6);
    border: 1px solid rgba(153, 0, 0, 0.7);
}

.header h1 {
    color: #ff6666;
    font-size: 32px;
    margin-bottom: 10px;
    text-shadow: 0 0 10px rgba(255, 102, 102, 0.7);
    animation: textGlow 3s infinite alternate;
}

@keyframes textGlow {
    0% { text-shadow: 0 0 10px rgba(255, 102, 102, 0.7); }
    100% { text-shadow: 0 0 20px rgba(255, 102, 102, 1), 0 0 30px rgba(255, 102, 102, 0.7); }
}

.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-box {
    background: linear-gradient(145deg, #1a0a0a, #2a0a0a);
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    border: 1px solid rgba(153, 0, 0, 0.5);
    box-shadow: 0 5px 15px rgba(153, 0, 0, 0.3);
    transition: transform 0.3s;
}

.stat-box:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 28px;
    font-weight: bold;
    color: #ff6666;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 14px;
    color: #aaa;
}

.control-panel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.panel-section {
    background: linear-gradient(145deg, #1a0a0a, #2a0a0a);
    padding: 25px;
    border-radius: 15px;
    border: 1px solid rgba(153, 0, 0, 0.5);
    box-shadow: 0 5px 15px rgba(153, 0, 0, 0.3);
}

.panel-section h2 {
    color: #ff6666;
    margin-bottom: 20px;
    font-size: 20px;
    border-bottom: 1px solid rgba(153, 0, 0, 0.5);
    padding-bottom: 10px;
}

.input-group {
    margin-bottom: 15px;
}

.input-group label {
    display: block;
    margin-bottom: 5px;
    color: #ff6666;
    font-weight: 600;
}

input, select, textarea {
    width:100%;
    padding:12px 15px;
    margin:5px 0;
    border-radius:12px;
    border:1px solid #990000;
    font-size:16px;
    transition: all 0.3s;
    background: rgba(20, 10, 10, 0.8);
    color: #e0e0e0;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
}

input:focus, select:focus, textarea:focus {
    border-color: #ff6666;
    box-shadow: 0 0 15px rgba(255, 102, 102, 0.7),
                inset 0 2px 5px rgba(0,0,0,0.5);
    transform: scale(1.02);
    outline: none;
}

button {
    padding:12px 20px;
    border:none;
    border-radius:12px;
    background: linear-gradient(145deg, #990000, #cc0000);
    color:#fff;
    font-weight:600;
    cursor:pointer;
    transition:0.3s;
    font-size:16px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(153, 0, 0, 0.6);
    margin: 5px;
}

button:hover {
    background: linear-gradient(145deg, #cc0000, #ff0000);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255, 0, 0, 0.8);
}

.btn-block {
    background: linear-gradient(145deg, #990000, #cc0000);
}

.btn-unblock {
    background: linear-gradient(145deg, #006600, #009900);
}

.btn-send {
    background: linear-gradient(145deg, #000066, #000099);
}

.btn-refresh {
    background: linear-gradient(145deg, #006666, #009999);
}

.btn-copy {
    background: linear-gradient(145deg, #663300, #996600);
    padding: 8px 15px;
    font-size: 14px;
}

.btn-timer-block {
    background: linear-gradient(145deg, #993300, #cc6600);
}

.user-list {
    max-height: 400px;
    overflow-y: auto;
    margin: 10px 0;
    padding: 10px;
    background: rgba(30, 15, 15, 0.6);
    border-radius: 10px;
    border: 1px solid rgba(153, 0, 0, 0.3);
}

.user-item {
    padding: 15px;
    margin: 8px 0;
    background: rgba(50, 20, 20, 0.6);
    border-radius: 10px;
    border: 1px solid rgba(153, 0, 0, 0.4);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s;
}

.user-item:hover {
    background: rgba(60, 25, 25, 0.8);
    transform: translateX(5px);
}

.user-info {
    flex: 1;
    text-align: left;
}

.user-id {
    font-weight: bold;
    color: #ff6666;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-details {
    font-size: 12px;
    color: #aaa;
}

.user-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.status-badge {
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 10px;
}

.status-active {
    background: rgba(0, 153, 0, 0.3);
    color: #66ff66;
    border: 1px solid #66ff66;
}

.status-blocked {
    background: rgba(153, 0, 0, 0.3);
    color: #ff6666;
    border: 1px solid #ff6666;
}

.status-timer-blocked {
    background: rgba(153, 102, 0, 0.3);
    color: #ffcc66;
    border: 1px solid #ffcc66;
}

.alert {
    margin-top:15px; 
    font-weight:600; 
    font-size:15px; 
    color:#e0e0e0;
    padding: 10px;
    border-radius: 10px;
    text-align: center;
}

.alert-success {
    background: rgba(0, 153, 0, 0.2);
    border: 1px solid #66ff66;
    color: #66ff66;
}

.alert-error {
    background: rgba(153, 0, 0, 0.2);
    border: 1px solid #ff6666;
    color: #ff6666;
}

.alert-info {
    background: rgba(0, 102, 153, 0.2);
    border: 1px solid #66ccff;
    color: #66ccff;
}

.quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 15px 0;
}

.quick-action-btn {
    flex: 1;
    min-width: 120px;
    padding: 10px;
    font-size: 14px;
}

.log-container {
    max-height: 300px;
    overflow-y: auto;
    background: rgba(20, 10, 10, 0.8);
    border-radius: 10px;
    padding: 15px;
    margin-top: 20px;
    border: 1px solid rgba(153, 0, 0, 0.3);
}

.log-entry {
    padding: 8px;
    margin: 5px 0;
    background: rgba(40, 20, 20, 0.6);
    border-radius: 5px;
    border-left: 3px solid #ff6666;
    font-size: 12px;
    color: #aaa;
}

.log-time {
    color: #ff6666;
    font-weight: bold;
}

.timer-control {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.timer-input {
    flex: 1;
}

.copy-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0, 153, 0, 0.8);
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    z-index: 1000;
    animation: slideInRight 0.3s, fadeOut 0.3s 1.7s forwards;
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(30, 15, 15, 0.6);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: rgba(153, 0, 0, 0.6);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 0, 0, 0.8);
}

.maintenance-message {
    background: rgba(153, 102, 0, 0.2);
    border: 1px solid #ffcc66;
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
}

.maintenance-message h3 {
    color: #ffcc66;
    margin-bottom: 10px;
}

.message-templates {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin: 15px 0;
}

.template-btn {
    background: linear-gradient(145deg, #006666, #009999);
    padding: 10px;
    font-size: 14px;
    text-align: center;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.template-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 153, 153, 0.5);
}

.broadcast-status {
    background: rgba(102, 0, 153, 0.2);
    border: 1px solid #cc66ff;
    border-radius: 10px;
    padding: 10px;
    margin: 10px 0;
    font-size: 14px;
}

.broadcast-status h4 {
    color: #cc66ff;
    margin-bottom: 5px;
}

.real-time-indicator {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0, 153, 0, 0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    z-index: 1000;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.user-countdown {
    font-size: 11px;
    color: #ffcc66;
    margin-top: 3px;
}

.reset-section {
    background: rgba(153, 0, 51, 0.2);
    border: 1px solid #ff3366;
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
}

.reset-section h3 {
    color: #ff3366;
    margin-bottom: 10px;
}

.danger-zone {
    background: rgba(255, 0, 0, 0.2);
    border: 2px solid #ff0000;
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
    animation: dangerPulse 2s infinite alternate;
}

@keyframes dangerPulse {
    0% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.3); }
    100% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.6); }
}

.danger-zone h3 {
    color: #ff0000;
    margin-bottom: 10px;
}

.danger-btn {
    background: linear-gradient(145deg, #cc0000, #ff0000);
    border: 1px solid #ff6666;
}

.danger-btn:hover {
    background: linear-gradient(145deg, #ff0000, #ff3333);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255, 0, 0, 0.8);
}

/* Firebase Connection Status */
.connection-status {
    position: fixed;
    top: 10px;
    left: 10px;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 5px;
}

.connected {
    background: rgba(0, 153, 0, 0.8);
    color: white;
}

.disconnected {
    background: rgba(255, 0, 0, 0.8);
    color: white;
}
</style>
</head>
<body>

<!-- Firebase Connection Status -->
<div class="connection-status" id="connectionStatus">
    <i class="fas fa-wifi"></i>
    <span>Firebase Connecting...</span>
</div>

<div class="real-time-indicator" id="realTimeIndicator">
    <i class="fas fa-sync-alt"></i> লাইভ আপডেট
</div>

<div class="header">
    <h1>🛡️ MR_TOOLS Admin Control Panel</h1>
    <p>ইউজার প্যানেলসমূহ রিয়েল-টাইমে কন্ট্রোল করুন</p>
</div>

<div class="stats-container">
    <div class="stat-box">
        <div class="stat-number" id="totalUsers">0</div>
        <div class="stat-label">মোট ইউজার</div>
    </div>
    <div class="stat-box">
        <div class="stat-number" id="activeUsers">0</div>
        <div class="stat-label">এক্টিভ ইউজার</div>
    </div>
    <div class="stat-box">
        <div class="stat-number" id="blockedUsers">0</div>
        <div class="stat-label">ব্লক ইউজার</div>
    </div>
    <div class="stat-box">
        <div class="stat-number" id="totalOrders">0</div>
        <div class="stat-label">মোট অর্ডার</div>
    </div>
</div>

<div class="control-panel">
    <!-- User Management Section -->
    <div class="panel-section">
        <h2>👥 ইউজার ম্যানেজমেন্ট</h2>
        
        <div class="input-group">
            <label>ইউজার সার্চ</label>
            <input type="text" id="searchUser" placeholder="ইউজার ID বা নাম লিখুন...">
        </div>
        
        <button class="btn-refresh" onclick="loadUsers()"><i class="fas fa-sync-alt"></i> ইউজার লিস্ট রিফ্রেশ</button>
        
        <div class="user-list" id="userList">
            <div class="user-item">
                <div class="user-info">
                    <div class="user-id">Firebase থেকে ডেটা লোড হচ্ছে...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Block/Unblock Section -->
    <div class="panel-section">
        <h2>🚫 ব্লক/আনব্লক কন্ট্রোল</h2>
        
        <div class="input-group">
            <label>ইউজার ID</label>
            <input type="text" id="blockUserId" placeholder="ব্লক/আনব্লক করার ইউজার ID">
        </div>
        
        <div class="input-group">
            <label>টাইমার ব্লক (মিনিট)</label>
            <div class="timer-control">
                <input type="number" id="blockMinutes" placeholder="মিনিট" class="timer-input" min="1" max="1440">
                <button class="btn-timer-block" onclick="timerBlockUser()"><i class="fas fa-clock"></i> টাইমার ব্লক</button>
            </div>
        </div>
        
        <div class="quick-actions">
            <button class="btn-block" onclick="blockUser()"><i class="fas fa-ban"></i> পার্মানেন্ট ব্লক</button>
            <button class="btn-unblock" onclick="unblockUser()"><i class="fas fa-check"></i> আনব্লক</button>
        </div>
        
        <div class="input-group">
            <label>দ্রুত একশন</label>
            <div class="quick-actions">
                <button class="btn-block quick-action-btn" onclick="blockAllUsers()">সবাইকে ব্লক করুন</button>
                <button class="btn-unblock quick-action-btn" onclick="unblockAllUsers()">সবাইকে আনব্লক করুন</button>
            </div>
        </div>
    </div>

    <!-- Message Control Section -->
    <div class="panel-section">
        <h2>💬 মেসেজ কন্ট্রোল</h2>
        
        <div class="maintenance-message">
            <h3><i class="fas fa-tools"></i> মেইন্টেনেন্স মেসেজ</h3>
            <p>এই মেসেজ ইউজারদের জানাবে যে সিস্টেমে কাজ চলছে এবং কিছুক্ষণের জন্য বন্ধ থাকবে</p>
        </div>
        
        <div class="input-group">
            <label>ব্রডকাস্ট মেসেজ (সবাইকে)</label>
            <textarea id="broadcastMessage" placeholder="সব ইউজারকে মেসেজ লিখুন..." rows="3"></textarea>
        </div>
        
        <div class="message-templates">
            <div class="template-btn" onclick="setMaintenanceMessage('সিস্টেম আপডেট')">সিস্টেম আপডেট</div>
            <div class="template-btn" onclick="setMaintenanceMessage('সার্ভিস বন্ধ')">সার্ভিস বন্ধ</div>
            <div class="template-btn" onclick="setMaintenanceMessage('কাজ চলছে')">কাজ চলছে</div>
            <div class="template-btn" onclick="setMaintenanceMessage('অল্প সময়ের জন্য বন্ধ')">অল্প সময়ের জন্য বন্ধ</div>
        </div>
        
        <div class="broadcast-status">
            <h4>বর্তমান ব্রডকাস্ট স্ট্যাটাস:</h4>
            <div id="currentBroadcast">কোনো এক্টিভ ব্রডকাস্ট নেই</div>
        </div>
        
        <div class="input-group">
            <label>প্রাইভেট মেসেজ</label>
            <input type="text" id="privateUserId" placeholder="ইউজার ID">
            <textarea id="privateMessage" placeholder="নির্দিষ্ট ইউজারকে মেসেজ লিখুন..." rows="3"></textarea>
        </div>
        
        <div class="quick-actions">
            <button class="btn-send" onclick="sendBroadcastMessage()"><i class="fas fa-bullhorn"></i> ব্রডকাস্ট পাঠান</button>
            <button class="btn-send" onclick="sendPrivateMessage()"><i class="fas fa-envelope"></i> প্রাইভেট পাঠান</button>
        </div>
    </div>
</div>

<!-- Reset Section -->
<div class="panel-section reset-section">
    <h2>🔄 ডেটা রিসেট সিস্টেম</h2>
    
    <div class="input-group">
        <label>নির্দিষ্ট ইউজার রিসেট</label>
        <input type="text" id="resetUserId" placeholder="রিসেট করার ইউজার ID">
        <button class="btn-refresh" onclick="resetSingleUser()"><i class="fas fa-user-slash"></i> ইউজার রিসেট করুন</button>
    </div>
    
    <div class="danger-zone">
        <h3>⚠️ ডেঞ্জার জোন - সতর্কতা!</h3>
        <p>এই অপারেশনগুলো বিপরীতমুখী নয়। সব ডেটা চিরতরে ডিলিট হয়ে যাবে।</p>
        
        <div class="quick-actions">
            <button class="danger-btn quick-action-btn" onclick="resetAllUserData()">
                <i class="fas fa-bomb"></i> সব ইউজার ডেটা রিসেট
            </button>
            <button class="danger-btn quick-action-btn" onclick="clearAllData()">
                <i class="fas fa-trash"></i> সব ডেটা ক্লিয়ার
            </button>
        </div>
        
        <div class="input-group">
            <label>শুধুমাত্র 8-ডিজিট ইউজার দেখান</label>
            <div class="quick-actions">
                <button class="btn-refresh quick-action-btn" onclick="toggleUserFilter()">
                    <i class="fas fa-filter"></i> <span id="filterText">8-ডিজিট ফিল্টার: ON</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Alert Box -->
<div class="alert" id="alertBox"></div>

<!-- Activity Log -->
<div class="panel-section">
    <h2>📋 অ্যাক্টিভিটি লগ</h2>
    <button class="btn-refresh" onclick="clearLogs()"><i class="fas fa-trash"></i> লগ ক্লিয়ার করুন</button>
    <div class="log-container" id="logContainer">
        <div class="log-entry">
            <span class="log-time">[সিস্টেম]</span> অ্যাডমিন প্যানেল চালু হয়েছে...
        </div>
    </div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyCCGGU1Tvy3HMd0bCi8X3R7Gda5ZtSCcXE",
    authDomain: "user-panel-e7fb6.firebaseapp.com",
    projectId: "user-panel-e7fb6",
    storageBucket: "user-panel-e7fb6.firebasestorage.app",
    messagingSenderId: "106974609939",
    appId: "1:106974609939:web:32542001892c4242c6f5e6",
    measurementId: "G-Y15T2HBY2J"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Firebase References
let usersRef, userActivityRef, blockedUsersRef, timerBlockedUsersRef, userMessagesRef, broadcastMessagesRef, adminLogsRef;

// Configuration
const BOT_TOKEN = "8443808388:AAGY7ewfQvC_KXxz8BlMd0OLiB6rkITRTTs";
const ADMIN_CHAT_ID = "7245153415";

// Initialize
let users = {};
let userActivity = {};
let blockedUsers = {};
let timerBlockedUsers = {};
let adminLogs = [];
let showOnly8DigitUsers = true;

// DOM Elements
const alertBox = document.getElementById('alertBox');
const connectionStatus = document.getElementById('connectionStatus');

// Statistics Elements
const totalUsersEl = document.getElementById('totalUsers');
const activeUsersEl = document.getElementById('activeUsers');
const blockedUsersEl = document.getElementById('blockedUsers');
const totalOrdersEl = document.getElementById('totalOrders');

// Initialize Firebase References
function initializeFirebaseReferences() {
    usersRef = database.ref('users');
    userActivityRef = database.ref('user_activity');
    blockedUsersRef = database.ref('blocked_users');
    timerBlockedUsersRef = database.ref('timer_blocked_users');
    userMessagesRef = database.ref('user_messages');
    broadcastMessagesRef = database.ref('broadcast_messages');
    adminLogsRef = database.ref('admin_logs');
}

// Setup Firebase Listeners
function setupFirebaseListeners() {
    // Users listener
    usersRef.on('value', (snapshot) => {
        users = snapshot.val() || {};
        updateStatistics();
        loadUsers();
    });

    // User Activity listener
    userActivityRef.on('value', (snapshot) => {
        userActivity = snapshot.val() || {};
        updateStatistics();
        loadUsers();
    });

    // Blocked Users listener
    blockedUsersRef.on('value', (snapshot) => {
        blockedUsers = snapshot.val() || {};
        updateStatistics();
        loadUsers();
    });

    // Timer Blocked Users listener
    timerBlockedUsersRef.on('value', (snapshot) => {
        timerBlockedUsers = snapshot.val() || {};
        updateStatistics();
        loadUsers();
    });

    // Admin Logs listener
    adminLogsRef.on('value', (snapshot) => {
        adminLogs = snapshot.val() || [];
        updateLogDisplay();
    });

    // Update connection status
    database.ref('.info/connected').on('value', (snapshot) => {
        if (snapshot.val() === true) {
            connectionStatus.className = 'connection-status connected';
            connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> <span>Firebase Connected</span>';
        } else {
            connectionStatus.className = 'connection-status disconnected';
            connectionStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> <span>Firebase Disconnected</span>';
        }
    });
}

// Initialize logs
function initializeLogs() {
    if (adminLogs.length === 0) {
        addLog('অ্যাডমিন প্যানেল চালু হয়েছে');
    }
}

// Update statistics from Firebase data
function updateStatistics() {
    const userCount = Object.keys(users).length;
    let active = 0;
    let blocked = 0;
    let orders = 0;

    Object.keys(userActivity).forEach(userId => {
        const user = userActivity[userId];
        if (user && user.orders) {
            orders += user.orders;
        }
        
        if (blockedUsers[userId]) {
            blocked++;
        } else if (isTimerBlocked(userId)) {
            blocked++;
        } else {
            active++;
        }
    });

    totalUsersEl.textContent = userCount;
    activeUsersEl.textContent = active;
    blockedUsersEl.textContent = blocked;
    totalOrdersEl.textContent = orders;
}

// Check if user is timer blocked
function isTimerBlocked(userId) {
    if (timerBlockedUsers[userId]) {
        const blockData = timerBlockedUsers[userId];
        const currentTime = new Date().getTime();
        const blockEndTime = blockData.blockTime + (blockData.duration * 60 * 1000);
        return currentTime < blockEndTime;
    }
    return false;
}

// Get remaining time for timer blocked users
function getRemainingTime(userId) {
    if (timerBlockedUsers[userId]) {
        const blockData = timerBlockedUsers[userId];
        const currentTime = new Date().getTime();
        const blockEndTime = blockData.blockTime + (blockData.duration * 60 * 1000);
        const remainingTime = blockEndTime - currentTime;
        
        if (remainingTime > 0) {
            const minutes = Math.floor(remainingTime / (60 * 1000));
            const seconds = Math.floor((remainingTime % (60 * 1000)) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        } else {
            // Remove expired timer block from Firebase
            timerBlockedUsersRef.child(userId).remove();
        }
    }
    return null;
}

// Update broadcast status from Firebase
function updateBroadcastStatus() {
    broadcastMessagesRef.limitToLast(1).once('value').then((snapshot) => {
        const broadcastStatus = document.getElementById('currentBroadcast');
        
        if (snapshot.exists()) {
            const broadcastData = snapshot.val();
            const broadcastKey = Object.keys(broadcastData)[0];
            const broadcast = broadcastData[broadcastKey];
            const time = new Date(broadcast.timestamp).toLocaleString();
            broadcastStatus.innerHTML = `
                <strong>মেসেজ:</strong> ${broadcast.message.substring(0, 50)}...<br>
                <strong>সময়:</strong> ${time}<br>
                <strong>স্ট্যাটাস:</strong> <span style="color:#66ff66">এক্টিভ</span>
            `;
        } else {
            broadcastStatus.textContent = 'কোনো এক্টিভ ব্রডকাস্ট নেই';
        }
    });
}

// Load users list from Firebase
function loadUsers() {
    const userList = document.getElementById('userList');
    const searchTerm = document.getElementById('searchUser').value.toLowerCase();
    
    let userArray = Object.entries(userActivity);
    
    // Apply 8-digit filter if enabled
    if (showOnly8DigitUsers) {
        userArray = userArray.filter(([userId, userData]) => /^\d{8}$/.test(userId));
    }
    
    // Apply search filter
    if (searchTerm) {
        userArray = userArray.filter(([userId, userData]) => 
            userId.toLowerCase().includes(searchTerm) ||
            (userData.platform && userData.platform.toLowerCase().includes(searchTerm))
        );
    }
    
    userList.innerHTML = '';
    
    if (userArray.length === 0) {
        userList.innerHTML = '<div class="user-item"><div class="user-info">কোন ইউজার খুঁজে পাওয়া যায়নি</div></div>';
        return;
    }
    
    // Sort by last active (newest first)
    userArray.sort((a, b) => new Date(b[1].lastActive || 0) - new Date(a[1].lastActive || 0));
    
    userArray.forEach(([userId, userData]) => {
        const isPermanentlyBlocked = blockedUsers[userId];
        const isTimerBlockedNow = isTimerBlocked(userId);
        const remainingTime = getRemainingTime(userId);
        
        let status = 'এক্টিভ';
        let statusClass = 'status-active';
        
        if (isPermanentlyBlocked) {
            status = 'পার্মানেন্ট ব্লক';
            statusClass = 'status-blocked';
        } else if (isTimerBlockedNow && remainingTime) {
            status = 'টাইমার ব্লক';
            statusClass = 'status-timer-blocked';
        }
        
        const userItem = document.createElement('div');
        userItem.className = 'user-item';
        userItem.innerHTML = `
            <div class="user-info">
                <div class="user-id">
                    <span>${userId}</span>
                    <button class="btn-copy" onclick="copyUserId('${userId}')"><i class="fas fa-copy"></i> কপি</button>
                    <span class="status-badge ${statusClass}">${status}</span>
                </div>
                <div class="user-details">
                    অর্ডার: ${userData.orders || 0} | 
                    শেষ অ্যাক্টিভ: ${userData.lastActive ? new Date(userData.lastActive).toLocaleString() : 'অজানা'} |
                    ডিভাইস: ${userData.platform || 'অজানা'}
                    ${isTimerBlockedNow && remainingTime ? `<div class="user-countdown">ব্লক শেষ: ${remainingTime}</div>` : ''}
                </div>
            </div>
            <div class="user-actions">
                <button class="btn-send" onclick="quickMessage('${userId}')" title="মেসেজ পাঠান"><i class="fas fa-comment"></i></button>
                ${!isPermanentlyBlocked && !isTimerBlockedNow ? 
                    `<button class="btn-block" onclick="blockUserById('${userId}')" title="ব্লক করুন"><i class="fas fa-ban"></i></button>
                     <button class="btn-timer-block" onclick="quickTimerBlock('${userId}')" title="টাইমার ব্লক"><i class="fas fa-clock"></i></button>` :
                    `<button class="btn-unblock" onclick="unblockUserById('${userId}')" title="আনব্লক করুন"><i class="fas fa-check"></i></button>`
                }
                <button class="btn-refresh" onclick="resetSingleUserById('${userId}')" title="রিসেট করুন"><i class="fas fa-redo"></i></button>
            </div>
        `;
        userList.appendChild(userItem);
    });
    
    addLog(`ইউজার লিস্ট লোড করা হয়েছে (মোট: ${userArray.length})`);
}

// Toggle user filter
function toggleUserFilter() {
    showOnly8DigitUsers = !showOnly8DigitUsers;
    document.getElementById('filterText').textContent = `8-ডিজিট ফিল্টার: ${showOnly8DigitUsers ? 'ON' : 'OFF'}`;
    loadUsers();
    showAlert(`8-ডিজিট ফিল্টার ${showOnly8DigitUsers ? 'চালু' : 'বন্ধ'} করা হয়েছে`, 'info');
}

// Copy user ID
function copyUserId(userId) {
    navigator.clipboard.writeText(userId).then(() => {
        showCopyNotification(`ইউজার ID কপি হয়েছে: ${userId}`);
    }).catch(err => {
        console.error('কপি করতে সমস্যা হয়েছে: ', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = userId;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showCopyNotification(`ইউজার ID কপি হয়েছে: ${userId}`);
    });
}

// Show copy notification
function showCopyNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'copy-notification';
    notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (document.body.contains(notification)) {
            document.body.removeChild(notification);
        }
    }, 2000);
}

// Quick timer block
function quickTimerBlock(userId) {
    const minutes = prompt(`${userId} ইউজারকে কত মিনিটের জন্য ব্লক করতে চান?`, "30");
    if (minutes && !isNaN(minutes) && minutes > 0) {
        timerBlockUserById(userId, parseInt(minutes));
    }
}

// Timer block user
function timerBlockUser() {
    const userId = document.getElementById('blockUserId').value.trim();
    const minutes = document.getElementById('blockMinutes').value;
    
    if (!userId) {
        showAlert('❌ ইউজার ID লিখুন!', 'error');
        return;
    }
    
    if (!minutes || isNaN(minutes) || minutes <= 0) {
        showAlert('❌ সঠিক মিনিট সংখ্যা লিখুন!', 'error');
        return;
    }
    
    timerBlockUserById(userId, parseInt(minutes));
    document.getElementById('blockMinutes').value = '';
}

// Timer block user by ID in Firebase
function timerBlockUserById(userId, minutes) {
    const blockData = {
        blockTime: new Date().getTime(),
        duration: minutes
    };
    
    timerBlockedUsersRef.child(userId).set(blockData);
    
    // Update user activity status
    userActivityRef.child(userId).update({
        status: 'timer_blocked',
        lastActive: new Date().toISOString()
    });
    
    showAlert(`✅ ইউজার ${userId} ${minutes} মিনিটের জন্য ব্লক করা হয়েছে!`, 'success');
    addLog(`ইউজার টাইমার ব্লক করা হয়েছে: ${userId} (${minutes} মিনিট)`);
    loadUsers();
    updateStatistics();
    document.getElementById('blockUserId').value = '';
}

// Block user
function blockUser() {
    const userId = document.getElementById('blockUserId').value.trim();
    blockUserById(userId);
}

// Block user by ID in Firebase
function blockUserById(userId) {
    if (!userId) {
        showAlert('❌ ইউজার ID লিখুন!', 'error');
        return;
    }
    
    blockedUsersRef.child(userId).set(true);
    
    // Update user activity status
    userActivityRef.child(userId).update({
        status: 'blocked',
        lastActive: new Date().toISOString()
    });
    
    showAlert(`✅ ইউজার ${userId} পার্মানেন্ট ব্লক করা হয়েছে!`, 'success');
    addLog(`ইউজার পার্মানেন্ট ব্লক করা হয়েছে: ${userId}`);
    loadUsers();
    updateStatistics();
    document.getElementById('blockUserId').value = '';
}

// Unblock user
function unblockUser() {
    const userId = document.getElementById('blockUserId').value.trim();
    unblockUserById(userId);
}

// Unblock user by ID from Firebase
function unblockUserById(userId) {
    if (!userId) {
        showAlert('❌ ইউজার ID লিখুন!', 'error');
        return;
    }
    
    let unblocked = false;
    
    // Remove from blocked users
    blockedUsersRef.child(userId).remove();
    
    // Remove from timer blocked users
    timerBlockedUsersRef.child(userId).remove();
    
    // Update user activity status
    userActivityRef.child(userId).update({
        status: 'active',
        lastActive: new Date().toISOString()
    });
    
    showAlert(`✅ ইউজার ${userId} আনব্লক করা হয়েছে!`, 'success');
    addLog(`ইউজার আনব্লক করা হয়েছে: ${userId}`);
    loadUsers();
    updateStatistics();
    document.getElementById('blockUserId').value = '';
}

// Block all users in Firebase
function blockAllUsers() {
    if (!confirm('⚠️ সব ইউজারকে ব্লক করতে চান?')) return;
    
    userActivityRef.once('value').then((snapshot) => {
        const userActivity = snapshot.val() || {};
        Object.keys(userActivity).forEach(userId => {
            blockedUsersRef.child(userId).set(true);
            userActivityRef.child(userId).update({
                status: 'blocked'
            });
        });
        
        showAlert('✅ সব ইউজার ব্লক করা হয়েছে!', 'success');
        addLog('সব ইউজার ব্লক করা হয়েছে');
        loadUsers();
        updateStatistics();
    });
}

// Unblock all users from Firebase
function unblockAllUsers() {
    if (!confirm('⚠️ সব ইউজারকে আনব্লক করতে চান?')) return;
    
    // Clear all blocked users
    blockedUsersRef.remove();
    timerBlockedUsersRef.remove();
    
    // Update all user statuses to active
    userActivityRef.once('value').then((snapshot) => {
        const userActivity = snapshot.val() || {};
        Object.keys(userActivity).forEach(userId => {
            userActivityRef.child(userId).update({
                status: 'active'
            });
        });
        
        showAlert('✅ সব ইউজার আনব্লক করা হয়েছে!', 'success');
        addLog('সব ইউজার আনব্লক করা হয়েছে');
        loadUsers();
        updateStatistics();
    });
}

// Reset single user from Firebase
function resetSingleUser() {
    const userId = document.getElementById('resetUserId').value.trim();
    resetSingleUserById(userId);
}

// Reset single user by ID from Firebase
function resetSingleUserById(userId) {
    if (!userId) {
        showAlert('❌ ইউজার ID লিখুন!', 'error');
        return;
    }
    
    if (!confirm(`⚠️ ইউজার ${userId} এর সব ডেটা রিসেট করতে চান?`)) return;
    
    // Remove user from all Firebase data
    usersRef.child(userId).remove();
    userActivityRef.child(userId).remove();
    blockedUsersRef.child(userId).remove();
    timerBlockedUsersRef.child(userId).remove();
    userMessagesRef.child(userId).remove();
    
    showAlert(`✅ ইউজার ${userId} এর সব ডেটা রিসেট করা হয়েছে!`, 'success');
    addLog(`ইউজার রিসেট করা হয়েছে: ${userId}`);
    loadUsers();
    updateStatistics();
    document.getElementById('resetUserId').value = '';
}

// Reset all user data from Firebase
function resetAllUserData() {
    if (!confirm('⚠️ সব ইউজারের ডেটা রিসেট করতে চান? এটি বিপরীতমুখী নয়!')) return;
    
    // Clear all user-related data from Firebase
    usersRef.remove();
    userActivityRef.remove();
    blockedUsersRef.remove();
    timerBlockedUsersRef.remove();
    userMessagesRef.remove();
    
    showAlert('✅ সব ইউজার ডেটা রিসেট করা হয়েছে!', 'success');
    addLog('সব ইউজার ডেটা রিসেট করা হয়েছে');
    loadUsers();
    updateStatistics();
}

// Clear all data from Firebase (nuclear option)
function clearAllData() {
    if (!confirm('🚨 সব ডেটা চিরতরে ডিলিট করতে চান? এটি সম্পূর্ণ বিপরীতমুখী নয়!')) return;
    if (!confirm('🚨 আপনি কি নিশ্চিত? সবকিছু ডিলিট হয়ে যাবে!')) return;
    
    // Clear all data from Firebase
    usersRef.remove();
    userActivityRef.remove();
    blockedUsersRef.remove();
    timerBlockedUsersRef.remove();
    userMessagesRef.remove();
    broadcastMessagesRef.remove();
    adminLogsRef.remove();
    
    showAlert('✅ সব ডেটা ক্লিয়ার করা হয়েছে!', 'success');
    addLog('সব ডেটা ক্লিয়ার করা হয়েছে');
    loadUsers();
    updateStatistics();
    updateLogDisplay();
}

// Set maintenance message template
function setMaintenanceMessage(type) {
    let message = '';
    
    switch(type) {
        case 'সিস্টেম আপডেট':
            message = '🚧 সিস্টেম আপডেট চলছে। কিছুক্ষণের জন্য সার্ভিস বন্ধ থাকবে। আপডেট শেষ হলে স্বয়ংক্রিয়ভাবে চালু হয়ে যাবে। ধন্যবাদ।';
            break;
        case 'সার্ভিস বন্ধ':
            message = '⛔ সার্ভিস সাময়িকভাবে বন্ধ রয়েছে। দ্রুত চালু করা হবে। আপনার ধৈর্যের জন্য ধন্যবাদ।';
            break;
        case 'কাজ চলছে':
            message = '🔧 সিস্টেমে কাজ চলছে। কিছুক্ষণের জন্য সার্ভিস বন্ধ থাকবে। কাজ শেষ হলে স্বয়ংক্রিয়ভাবে চালু হয়ে যাবে।';
            break;
        case 'অল্প সময়ের জন্য বন্ধ':
            message = '⏳ সার্ভিস অল্প সময়ের জন্য বন্ধ রয়েছে। দ্রুত চালু করা হবে। আপনার সহযোগিতার জন্য ধন্যবাদ।';
            break;
    }
    
    document.getElementById('broadcastMessage').value = message;
}

// Send broadcast message to Firebase
function sendBroadcastMessage() {
    const message = document.getElementById('broadcastMessage').value.trim();
    if (!message) {
        showAlert('❌ মেসেজ লিখুন!', 'error');
        return;
    }
    
    // Store broadcast message in Firebase for users to read
    const broadcastId = 'broadcast_' + Date.now();
    const broadcastData = {
        message: message,
        timestamp: new Date().toISOString(),
        type: 'broadcast'
    };
    
    broadcastMessagesRef.child(broadcastId).set(broadcastData);
    
    showAlert(`✅ ব্রডকাস্ট মেসেজ পাঠানো হয়েছে!`, 'success');
    addLog(`ব্রডকাস্ট মেসেজ পাঠানো হয়েছে: "${message}"`);
    updateBroadcastStatus();
    
    // Clear the input field
    document.getElementById('broadcastMessage').value = '';
}

// Send private message to Firebase
function sendPrivateMessage() {
    const userId = document.getElementById('privateUserId').value.trim();
    const message = document.getElementById('privateMessage').value.trim();
    
    if (!userId || !message) {
        showAlert('❌ ইউজার ID এবং মেসেজ লিখুন!', 'error');
        return;
    }
    
    // Check if user exists
    userActivityRef.child(userId).once('value').then((snapshot) => {
        if (!snapshot.exists()) {
            showAlert('❌ ইউজার ID সঠিক নয়!', 'error');
            return;
        }
        
        // Store private message for specific user in Firebase
        const messageId = 'message_' + Date.now();
        const messageData = {
            message: message,
            timestamp: new Date().toISOString(),
            read: false
        };
        
        userMessagesRef.child(userId).child(messageId).set(messageData);
        
        showAlert(`✅ মেসেজ ইউজার ${userId} কে পাঠানো হয়েছে!`, 'success');
        addLog(`প্রাইভেট মেসেজ পাঠানো হয়েছে: ${userId} - "${message}"`);
        
        // Clear the input fields
        document.getElementById('privateUserId').value = '';
        document.getElementById('privateMessage').value = '';
    });
}

// Quick message to user via Firebase
function quickMessage(userId) {
    const message = prompt(`ইউজার ${userId} কে মেসেজ লিখুন:`);
    if (message) {
        const messageId = 'message_' + Date.now();
        const messageData = {
            message: message,
            timestamp: new Date().toISOString(),
            read: false
        };
        
        userMessagesRef.child(userId).child(messageId).set(messageData);
        showAlert(`✅ মেসেজ পাঠানো হয়েছে!`, 'success');
        addLog(`দ্রুত মেসেজ পাঠানো হয়েছে: ${userId} - "${message}"`);
    }
}

// Log management with Firebase
function addLog(message) {
    const logId = 'log_' + Date.now();
    const logEntry = {
        time: new Date().toLocaleString(),
        message: message
    };
    
    adminLogsRef.child(logId).set(logEntry);
}

function updateLogDisplay() {
    const logContainer = document.getElementById('logContainer');
    logContainer.innerHTML = '';
    
    // Convert object to array and sort by timestamp
    const logArray = Object.entries(adminLogs)
        .map(([key, value]) => ({ key, ...value }))
        .sort((a, b) => new Date(b.key.replace('log_', '')) - new Date(a.key.replace('log_', '')));
    
    logArray.forEach(log => {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `<span class="log-time">[${log.time}]</span> ${log.message}`;
        logContainer.appendChild(logEntry);
    });
}

function clearLogs() {
    if (!confirm('⚠️ সব লগ ডিলিট করতে চান?')) return;
    
    adminLogsRef.remove();
    showAlert('✅ সব লগ ক্লিয়ার করা হয়েছে!', 'success');
}

// Utility functions
function showAlert(message, type) {
    alertBox.className = `alert alert-${type}`;
    alertBox.textContent = message;
    setTimeout(() => {
        alertBox.textContent = '';
        alertBox.className = 'alert';
    }, 5000);
}

// Initialize the application
function initializeApp() {
    initializeFirebaseReferences();
    setupFirebaseListeners();
    initializeLogs();
    
    // Initial data load
    updateStatistics();
    loadUsers();
    updateBroadcastStatus();
    updateLogDisplay();
}

// Auto-refresh system
function refreshData() {
    updateStatistics();
    updateBroadcastStatus();
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    
    // Auto-refresh every 3 seconds
    setInterval(refreshData, 3000);
    
    // Auto-refresh user list every 5 seconds
    setInterval(loadUsers, 5000);
    
    // Update real-time indicator
    setInterval(() => {
        const indicator = document.getElementById('realTimeIndicator');
        indicator.style.animation = 'none';
        setTimeout(() => {
            indicator.style.animation = 'pulse 2s infinite';
        }, 10);
    }, 3000);
});

// Search functionality
document.getElementById('searchUser').addEventListener('input', loadUsers);

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl + R to refresh
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        loadUsers();
        refreshData();
        showAlert('🔄 ডেটা রিফ্রেশ করা হয়েছে!', 'info');
    }
    
    // Ctrl + F to focus search
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        document.getElementById('searchUser').focus();
    }
});
</script>

</body>
</html>
